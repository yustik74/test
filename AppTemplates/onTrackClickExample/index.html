<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>onSelectCar example</title>
</head>
<script src="external-settings.js"></script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js" type="text/javascript"></script>
<script src="https://kendo.cdn.telerik.com/2021.1.119/js/kendo.all.min.js"></script>
<link rel="stylesheet" href="https://kendo.cdn.telerik.com/2021.1.119/styles/kendo.default-v2.min.css" />
</head>
<body>
<pre id="params" style="white-space: pre;"></pre>

<div id="grid1"></div>
<div id="grid2"></div>
<script>
    //в external-settings хранятся настройки текущей сессии, в том числе адрес API и токен текущей сессии
    var parm = window['external-settings'];
    //токен для API сервиса https://rapidapi.com/darkskyapis/api/dark-sky
    var rapidApiToken = "a99ed6ea3cmshe42862c83561be7p114f6djsn5291a66ef649";
    //API URL
    var hostUrl = "dark-sky.p.rapidapi.com";

    var columns1 = [
        {field: "temperature", title: "Температура"},
        {field: "apparentTemperature", title: "По ощущению"},
        {field: "dewPoint", title: "Точка росы"},
        {field: "humidity", title: "Влажность"},
        {field: "precipProbability", title: "Вероятность осадков"},
        {field: "precipType", title: "Тип осадков"},
        {field: "summary", title: "Итог"},
    ];

    var columns2 = [
        {field: "pressure", title: "Давление"},
        {field: "visibility", title: "Видимость"},
        {field: "windBearing", title: "Направление ветра"},
        {field: "windGust", title: "Скорость ветра"},
        {field: "windSpeed", title: "Порывы ветра"}
    ];

    function updateTable(table, inputColumns, dataSource) {
        if (dataSource.length > 0)
            $(`#${table}`).kendoGrid({
                columns: inputColumns,
                dataSource: {
                    data: dataSource
                }
            });
    }

    //подготовка первой части данных для kendo
    function createDataSource1(input)
    {
        var dataSource = new Object();
        dataSource.temperature = input.temperature + " °C";
        dataSource.apparentTemperature = input.apparentTemperature + " °C";
        dataSource.dewPoint = input.dewPoint + " °C";
        dataSource.humidity = input.humidity + "%";
        dataSource.precipProbability = input.precipProbability + "%";
        dataSource.precipType = input.precipType;
        dataSource.summary = input.summary;
        return [dataSource];
    }

    //подготовка второй части данных для kendo
    function createDataSource2(input)
    {
        var dataSource = new Object();
        dataSource.pressure = input.pressure + " Pa";
        dataSource.visibility = input.visibility + " км";
        dataSource.windBearing = input.windBearing + "°";
        dataSource.windGust = input.windGust + " м/с";
        dataSource.windSpeed = input.windSpeed + " м/с";
        return [dataSource];
    }

    function formatDateUtcForDarkSkyApi(date) {
        var twoDigitMonth = ((date.getUTCMonth() + 1) >= 10) ? (date.getUTCMonth() + 1) : '0' + (date.getUTCMonth() + 1);
        var twoDigitDate = ((date.getUTCDate()) >= 10) ? (date.getUTCDate()) : '0' + (date.getUTCDate());
        var twoDigitHours = ((date.getUTCHours()) >= 10) ? (date.getUTCHours()) : '0' + (date.getUTCHours());
        var twoDigitMinutes = ((date.getUTCMinutes()) >= 10) ? (date.getUTCMinutes()) : '0' + (date.getUTCMinutes());
        var twoDigitSeconds = ((date.getUTCSeconds()) >= 10) ? (date.getUTCSeconds()) : '0' + (date.getUTCSeconds());
        return `${date.getUTCFullYear()}-${twoDigitMonth}-${twoDigitDate}T${twoDigitHours}:${twoDigitMinutes}:${twoDigitSeconds}`;
    }

    window.parent.AppDispatcher.add('TrackClickListener', {
        onTrackClick: function (car, point, angle, pntIndex, timePos, dist, info) {
            console.info('onTrackClick', {
                car: car,
                point: point,
                angle: angle,
                pntIndex: pntIndex,
                timePos: timePos,
                dist: dist,
                info: info
            });
            //инициализируем пустые таблицы
            updateTable("grid1", columns1, []);
            updateTable("grid2", columns2, []);

            //подготовка настроек для get-запроса сервису, в point находятся координаты точки, в info.dt время
            const settings = {
                "async": true,
                "crossDomain": true,
                "url": `https://${hostUrl}/${point.lat},${point.lng},${formatDateUtcForDarkSkyApi(info.dt)}Z?lang=ru`,
                "method": "GET",
                "headers": {
                    "x-rapidapi-key": rapidApiToken,
                    "x-rapidapi-host": hostUrl
                }
            };

            $.ajax(settings).done(function (response) {
                console.log(response);
                //в currently находится погода из истории на запрошенный момент времени
                var dataSource = response.currently;
                dataSource.humidity *= 100;
                dataSource.precipProbability *= 100;
                //делим параметры на две таблицы и заполняем их
                updateTable("grid1", columns1, createDataSource1(dataSource));
                updateTable("grid2", columns2, createDataSource2(dataSource));
            });
        }
    });
</script>
</body>
</html>